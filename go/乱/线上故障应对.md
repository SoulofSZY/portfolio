## 线上故障处理

### 应对故障
**故障发生时**

快速恢复故障，快速定位故障源，故障在系统间扩散前快速定位故障。

故障源团队常用的恢复系统的手段

1. **重启和限流**。 重启和限流主要解决的是可用性问题，不是功能性问题。重启相对容易，但限流则需要相关的流控中间件。
2. **回滚操作**。 回滚操作一般来说是解决新代码的bug,把代码回滚到之前的版本是快速的方式
3. **降级操作**。并不是所有的代码变更都是能够被回滚的，如果无法回滚，就需要降级功能了。也就是说，需要挂一个停止服务的故障公告，避免事态的进一步扩大
4. **紧急更新**。紧急更新是常用的手段，需要强大的自动化系统，尤其是自动化测试和自动化发布系统。

出现故障时，最重要的不是debug故障，而是尽可能地减少故障的影响范围，并尽可能快的修复问题

**故障前的准备工作**

为了能够在面临故障时做得有条不紊，需要一些前期的准备工作。这些准备工作做得越细，那么故障处理起来也就越有条理。
故障来临时，一切都会变的混乱，此时，对于需要处理故障的我们来说，事可以乱，但人不能乱，如果人也跟着事一起乱，那就是真正的混乱了。

故障前的准备工作

APM式系统，开源：zipkin

1. **以用户功能为索引的服务和资源的全视图**。需要一个系统来记录前端用户操作界面和后端服务，以及服务所使用到的硬件资源之间的关联关系。以用户端功能作为索引，把后端的服务、服务的调度关系，以及服务使用到的资源都关联起来做成的一个视图。这个视图最好是由相应的自动化监控系统生成。有了这个资源图，就可以很容易的找到处理故障的路径
2. **为地图中的各个服务制订关键指标，以及一套运维流程和工具，包括应急方案**，以用户功能为索引，为每个用户功能的服务都制订一个服务故障的检测、处理和恢复手册，以及相关的检测、查错或是恢复的运维工具。对于基础层和一些通用的中间件，也需要有相应的最佳实践的方法。
3.  **设定故障等级**。设定不同故障等级的处理方式。如：亚马逊一般将故障分为4级：1级是全站不可用；2级是某功能不可用，且无替代方案；3级是某功能不可用，但有替代方案；4级是非功能性故障，或是用户不关心的故障。制定故障级别，主要是为了确定该故障要牵扯进多大规模的人员来处理。同时也可映射到不同级别的警报，触发不同的处理流程
4.  **故障演练**。要想提高处理故障水平，最好的方式就是实践，见得多了，处理得多了，才能驾轻就熟。故障演练是一个非常好的实践
5.  **灰度发布系统**。减少线上故障的影响范围，通过灰度发布系统来发布是一个很不错的方式。

### 故障排除后

**在故障排除后，如何做故障复盘及整改优化则更为重要**

**故障复盘过程**

案例1：亚马逊
亚马逊内部面对S1和S2的故障复盘，需要那个团队的经理写一个叫COE（Correction of Errors）的文档，包括以下内容：

1. 故障处理的整个过程。就像一个log一样，需要详细地记录几点几分干了什么事，把故障从发生到解决的所有细节过程都记录下来
2. 故障原因分析。需要说明故障的原因和分析报告
3. Ask 5 Whys。需要反思并反问至少5个为什么，并为这些“为什么”找到答案
4. 故障后续整改计划。需要针对上述的“Ask 5 Whys”说明后续如何举一反三地从根本上解决所有的问题

案例2： 阿里
阿里的故障复盘会会把所有的相关人员都叫到现场进行复盘，一方面信息是透明的，另一方面，也是对大家的一次教育。阿里的故障处理内容和亚马逊的很相似，只是没有“Ask 5 Whys”，但是加入了“故障等级”和“故障责任人”。对于比较大的故障，责任人基本上都是由P9/M4的人来承担。而且对于引发故障的直接工程师，阿里是会有相关的惩罚机制的，比如，全年无加薪无升职，或者罚款


**故障整改**

提出这些问题的大致逻辑

1. 优化故障获知和故障定位的时间
	1. 从故障发生到我们知道的时间是否可以优化得更短？
	2. 定位故障的时间是否可以更短？
	3. 有哪些地方可以做到自动化
2. 优化故障的处理方式
	1. 故障处理时的判断和章法是否科学，是否正确
	2. 故障处理时的信息是否全透明
	3. 故障处理时人员是否安排得当
3. 优化开发过程中的问题
	1. Code Review和测试中的问题和优化点
	2. 软件架构和设计是否可以更好
	3. 对于技术欠债或是相关的隐患问题是否被记录下来，是否有风险计划
4. 优化团队能力
	1. 如何提高团队的技术能力
	2. 如何让团队有严谨的工程意识

**根除问题的本质**

1.  **举一反三解决当下的故障**。为自己赢得更多的时间
2.  **简化复杂、不合理的技术架构、流程和组织**。你不可能在一个复杂的环境下根本地解决问题
3.  **全面改善和优化整个系统，包括组织。解决问题的根本方法是改善和调整整体结构**。而只有简单优雅的东西才有被改善和优化的可能