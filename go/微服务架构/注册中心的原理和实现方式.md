## 注册中心的原理和实现方式

### 原理
>服务提供者（RPC Server）、服务消费者（RPC Client）和服务注册中心（Registry）

**服务提供者**

1. 根据配置信息向服务注册中心注册自身服务
2. 向注册中心定期发送心跳汇报存活状态

**服务消费者**

1. 根据配置信息向服务注册中心订阅服务
2. 将服务注册中心返回的服务节点列表缓存在本地内存
3. 与RPC Server建立连接

**其他**

1. 服务提供者发生变更，注册中心同步变更，服务消费者感知后刷新本地内存中的服务节点缓存
2. 服务消费者从本地缓存服务节点列表，基于负载均衡算法选择一台服务提供者发起调用

### 注册中心实现方式

**待解决问题**

1. 需要提供哪些接口？
2. 如何部署？
3. 如何存储服务信息？
4. 如何监控服务提供者节点的存活？
5. 服务提供者节点变更，如何通知服务消费者？
6. 如何控制注册中心的访问权限？

**注册中心API**

> 根据注册中心原理的描述，注册中心必须提供以下最基本的API，例如：
> 
> 服务注册接口：服务提供者通过调用服务注册接口来完成服务注册。
> 
> 服务反注册接口：服务提供者通过调用服务反注册接口来完成服务注销。
> 
> 心跳汇报接口：服务提供者通过调用心跳汇报接口完成节点存活状态上报。
> 
> 服务订阅接口：服务消费者通过调用服务订阅接口完成服务订阅，获取可用的服务提供者节点列表。
> 
> 服务变更查询接口：服务消费者通过调用服务变更查询接口，获取最新的可用服务节点列表。
> 
> 除此之外，为了便于管理，注册中心还必须提供一些后台管理的API，例如：
> 
> 服务查询接口：查询注册中心当前注册了哪些服务信息。
> 
> 服务修改接口：修改注册中心中某一服务的信息

**部署**
>注册中心一般都是采用集群部署来保证高可用性，并通过分布式一致性协议来确保集群中不同节点之间的数据保持一致

**服务信息存储**
>注册中心存储服务信息一般采用层次化的目录结构

**服务健康检查**
>注册中心除了要支持最基本的服务注册和服务订阅功能以外，还必须具备对服务提供者节点的健康状态检测功能，这样才能保证注册中心里保存的服务节点都是可用的

ZooKeeper为例，它是基于ZooKeeper客户端和服务端的长连接和会话超时控制机制，来实现服务健康状态检测的

**服务状态变更通知**
>一旦注册中心探测到有服务提供者节点新加入或者被剔除，就必须立刻通知所有订阅该服务的服务消费者，刷新本地缓存的服务节点信息，确保服务调用不会请求不可用的服务提供者节点。

**白名单机制**


### 相关实现
1. zookeeper
	1. https://blog.csdn.net/java_66666/article/details/81015302
	2. http://www.sohu.com/a/323031234_120104204
2. eureka
3. consul


### 识别服务节点是否存活
>如果遇到网络不可靠等因素，可能会带来的两个问题，一个是服务消费者同时并发访问注册中心获取最新服务信息导致注册中心带宽被打满；另一个是服务提供者节点被大量摘除导致服务消费者没有足够的节点可以调用

>心跳开关保护机制和服务节点摘除保护机制

静态注册中心